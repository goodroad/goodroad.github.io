<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>로드킬 지표</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-iropke-batang/1.2/font-iropke-batang.css">
  <link rel="stylesheet" type="text/css" href="../semantic/semantic.min.css"/>

  <style>
    svg .municipality { fill: red; }
    svg .municipality:hover { stroke: #333; }
    svg .municipality.p0 { fill: rgb(247, 251, 255); }
    svg .municipality.p1 { fill: rgb(222, 235, 247); }
    svg .municipality.p2 { fill: rgb(198, 219, 239); }
    svg .municipality.p3 { fill: rgb(158, 202, 225); }
    svg .municipality.p4 { fill: rgb(107, 174, 214); }
    svg .municipality.p5 { fill: rgb(66, 146, 198); }
    svg .municipality.p6 { fill: rgb(33, 113, 181); }
    svg .municipality.p7 { fill: rgb(8, 81, 156); }
    svg .municipality.p8 { fill: rgb(8, 48, 107); }
    svg text { font-size: 20px; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="top_menu" class="fixed top-menu">
    <div class="ui container">
      <div id="menu-group" class="gui menu righted">
        <a href="#page1" class="gui menu-btn">굿로드 소개</a>
        <a href="#page2" class="menu-btn">로드킬이란?</a>
        <a href="#page3" class="on menu-btn">로드킬 지표</a>
      </div>
    </div>
  </div>

  <div class="contents" style="margin-top: 60px;">
    <div class="ui secondary pointing menu">
      <a class="item" href="./indicator_map.html">로드킬 전체지도</a>
      <a class="item" href="./indicator_location.html">지역별</a>
      <a class="active item" href="./indicator_animal.html">동물별</a>
      <a class="item" href="./indicator_month.html">월별</a>
    </div>
    <div class="ui segment">
      <div>
        <select id="year" class="ui dropdown">
        </select>

        <button id="searchBtn" class="ui button">검색</button>
      </div>

      <div id="chart" align="center"></div>
    </div>
  </div>
  <div class="footer">
    <div class="page-center">
    </div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="../js/goodroad-selectbox-data.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="../js/d3pie.min.js"></script>
<script src="../js/lodash.js"></script>
<script>

  function onSearch(){
    $.get('http://rest.goodroad.co.kr/group1?year=' + $('#year').val(), '', function (remoteData) {
      var data = [];
      $.each(remoteData, function (k, v) {
        var obj = new Object();
        obj.label = v[0];
        obj.value = v[1];
        data.push(obj);
      });

      pie.updateProp("data.content", data);
    })
  }

  var pie;
  function initChart(){
    var data = [];
    $.get('http://rest.goodroad.co.kr/group1?year=' + $('#year').val(), '', function (remoteData) {
      $.each(remoteData, function(k, v){
        var obj = new Object();
        obj.label = v[0];
        obj.value = v[1];
        data.push(obj);
      })

      pie = new d3pie("chart", {
        "size": {
          "canvasWidth": 590,
          "pieInnerRadius": "60%",
          "pieOuterRadius": "90%"
        },
        "data": {
          "sortOrder": "value-desc",
          "content": data
        },
        "labels": {
          "outer": {
            "pieDistance": 32
          },
          "inner": {
            "hideWhenLessThanPercentage": 1
          },
          "mainLabel": {
            "fontSize": 11
          },
          "percentage": {
            "color": "#ffffff",
            "decimalPlaces": 0
          },
          "value": {
            "color": "#adadad",
            "fontSize": 11
          },
          "lines": {
            "enabled": true
          },
          "truncation": {
            "enabled": true
          }
        },
        "effects": {
          "pullOutSegmentOnClick": {
            "speed": 400,
            "size": 8
          }
        },
        "tooltips": {
          enabled: true,
          type: "placeholder",
          string: "{label} : {value} 건"
        },
        "misc": {
          "colors": {
            segments: [
               "#eec314","#e37f4e","#91c69b","#486085","#367571"
              ,"#c1bb14","#594830","#495930","#4f9e5e","#6a6603"
              ,"#53438f","#a98804","#b15c33","#16524e","#2e215e"
              ,"#443014","#324614","#1a3256"
            ]
          }
        },
        "callbacks": {
          onClickSegment: function(d) {
            var label = d.data.label;

            if(label == '포유류' || label == '조류' || label == '양서류' || label == '파충류' || label == '기타'){
              $.get('http://rest.goodroad.co.kr/api/reports/search/group1year?p=' + label + '&year=' + $('#year').val(), '', function (data) {
                var result = _.chain(data._embedded.reports)
                  .groupBy("group2")
                  .value();

                data = [];
                $.each(result, function(k, v){
                  var obj = new Object();
                  obj.label = k;
                  obj.value = v.length;

                  data.push(obj);
                });

                pie.updateProp("data.content", data);
              });
            }
          }}
      });
    });
  }

  $(document).ready(function(){
    $('#year').setYearSelectData();
    $('#searchBtn').click(function(){
      onSearch();
    });

    initChart();
  });
</script>
</body>
</html>