<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta charset="UTF-8">
    <title>로드킬 사고발생 지도</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/image.css">
    <link rel="stylesheet" href="../css/select.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-iropke-batang/1.2/font-iropke-batang.css">
    <link rel="stylesheet" type="text/css" href="../semantic/semantic.min.css"/>

    <style>
        #container {overflow:hidden;height:500px;position:relative;}
        #mapWrapper {width:100%;height:500px;z-index:1;}
        #rvWrapper {width:50%;height:500px;top:0;right:0;position:absolute;z-index:0;}
        #container.view_roadview #mapWrapper {width: 50%;}
        #roadviewControl {position:absolute;top:5px;left:5px;width:65px;height:24px;padding:2px;z-index: 1;background: #f7f7f7;border-radius: 4px;border: 1px solid #c8c8c8;box-shadow: 0px 1px #888;cursor: pointer;}
        #roadviewControl span {background: url(http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/mapworker.png) no-repeat;  padding-left:23px;height:24px;font-size: 12px;display: inline-block;line-height: 2;font-weight: bold;}
        #roadviewControl.active {background: #ccc;box-shadow: 0px 1px #5F616D;border: 1px solid #7F818A;}
        #roadviewControl.active span {background: url(http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/mapworker_on.png) no-repeat;color: #4C4E57;}
        #close {position: absolute;padding: 4px;top: 5px;left: 5px;cursor: pointer;background: #fff;border-radius: 4px;border: 1px solid #c8c8c8;box-shadow: 0px 1px #888;}
        #close .img {display: block;background: url(http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;width: 14px;height: 14px;}
    </style>
</head>
<body>
<div id="wrap">
    <div id="top_menu" class="fixed top-menu">
        <div id="menu-group" class="page-center">
            <a class="logo menu-btn" href="/html/index.html#header"><img src="/html/images/intro_logo.png" class="intro-logo"/></a>
            <div class="gui menu righted">
                <a href="/html/about.html">굿로드 소개</a>
                <a href="/html/indicators/indicator_map.html" class="gui on menu-btn">로드킬 지표</a>
                <a href="/html/news.html">굿로드 뉴스</a>
            </div>
        </div>
    </div>

    <div class="contents page-center" style="margin-top: 100px;">
        <div class="ui four item stackable tabs menu" style="border-radius: 0.1rem; box-shadow: none;">
            <a style="background-color: #eec314" class="active item" href="./indicator_map.html">로드킬 전체지도</a>
            <a class="item" href="./indicator_location.html">지역별</a>
            <a class="item" href="./indicator_animal.html">동물별</a>
            <a class="item" href="./indicator_month.html">월별</a>
        </div>

        <div style="margin-bottom: 10px;">
            <div class="styled-select">
                <select id="year">
                </select>
            </div>
            <button id="searchBtn" class="ui button">검색</button>
        </div>

        <div id="container">
            <div id="rvWrapper">
                <div id="roadview" style="width:100%;height:100%;"></div> <!-- 로드뷰를 표시할 div 입니다 -->
                <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
            </div>
            <div id="mapWrapper">
                <div id="map" style="width:100%;height:100%;"></div>
                <div id="roadviewControl" onclick="setRoadviewRoad()"><span>로드뷰</span></div>
            </div>
        </div>

        <div id="info" class="info" style="margin-top: 10px;" align="right">
            <p>로드킬 자료 제공: 한국도로공사, 국립공원관리공단, 경남야생동물구조센터,전남야생동물구조센터, 충남야생동물구조센터, 김봉균</p>
        </div>
    </div>

    <div class="footer-line page-center"></div>

    <div class="footer">
        <div class="page-center">
            <div class="footer-copy">
                <div class="copy copy-logo"><img src="../images/about_footerlogo.png" height="99" width="112"/></div>
                <div class="copy copy-text">
                    <p>‘굿로드’는 공익적 사회변화를 위해 여러 분야의 사람들이 자발적인 참여로 36시간 동안 웹과 어플리케이션 등의 형태로
                        <br/>아이디어를 실제 구현하는 사회혁신 프로젝트 소셜이노베이션캠프 36을 통해 개발되었습니다.</p>
                    <p><u>문의</u>
                        / 녹색연합 / 이메일 greenkorea@greenkorea.org / 전화 02-747-8500 / 주소 서울시 성북구 성북로19길 15
                    </p>
                    <p></p>
                    <p>ⓒ2017. goranirani All right Reserved</p>
                </div>
                <div class="copy copy-sicamp"><img src="../images/about_footersicamp.png" height="99" width="264"/></div>
            </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="../semantic/semantic.min.js"></script>
<script src="../js/goodroad-selectbox-data.js"></script>
<script type="text/javascript" src="//apis.daum.net/maps/maps3.js?apikey=6c8b5962143b5a1331b52b5403663307&libraries=clusterer"></script>
<script type="text/javascript">

  var overlayOn = false, // 지도 위에 로드뷰 오버레이가 추가된 상태를 가지고 있을 변수
    container = document.getElementById('container'), // 지도와 로드뷰를 감싸고 있는 div 입니다
    mapWrapper = document.getElementById('mapWrapper'), // 지도를 감싸고 있는 d`iv 입니다
    mapContainer = document.getElementById('map'), // 지도를 표시할 div 입니다
    rvContainer = document.getElementById('roadview'); //로드뷰를 표시할 div 입니다

  var map = new daum.maps.Map(mapContainer, { // 지도를 표시할 div
    center : new daum.maps.LatLng(36.2683, 127.6358), // 지도의 중심좌표
    level : 13 // 지도의 확대 레벨
  });

  // 마커 클러스터러를 생성합니다
  var clusterer = new daum.maps.MarkerClusterer({
    map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
    averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
    minLevel: 10, // 클러스터 할 최소 지도 레벨
    calculator: [50, 100, 200], // 클러스터의 크기 구분 값, 각 사이값마다 설정된 text나 style이 적용된다
    styles: [{ // calculator 각 사이 값 마다 적용될 스타일을 지정한다
      width : '30px', height : '30px',
      background: 'rgba(51, 204, 255, .8)',
      borderRadius: '15px',
      color: '#000',
      textAlign: 'center',
      fontWeight: 'bold',
      lineHeight: '31px'
    },
      {
        width : '40px', height : '40px',
        background: 'rgba(255, 153, 0, .8)',
        borderRadius: '20px',
        color: '#000',
        textAlign: 'center',
        fontWeight: 'bold',
        lineHeight: '41px'
      },
      {
        width : '50px', height : '50px',
        background: 'rgba(255, 51, 204, .8)',
        borderRadius: '25px',
        color: '#000',
        textAlign: 'center',
        fontWeight: 'bold',
        lineHeight: '51px'
      },
      {
        width : '60px', height : '60px',
        background: 'rgba(255, 80, 80, .8)',
        borderRadius: '30px',
        color: '#000',
        textAlign: 'center',
        fontWeight: 'bold',
        lineHeight: '61px'
      }
    ]
  });

  // 로드뷰 객체를 생성합니다
  var rv = new daum.maps.Roadview(rvContainer);

  // 좌표로부터 로드뷰 파노라마 ID를 가져올 로드뷰 클라이언트 객체를 생성합니다
  var rvClient = new daum.maps.RoadviewClient();

  // 로드뷰에 좌표가 바뀌었을 때 발생하는 이벤트를 등록합니다
  daum.maps.event.addListener(rv, 'position_changed', function() {

    // 현재 로드뷰의 위치 좌표를 얻어옵니다
    var rvPosition = rv.getPosition();

    // 지도의 중심을 현재 로드뷰의 위치로 설정합니다
    map.setCenter(rvPosition);

    // 지도 위에 로드뷰 도로 오버레이가 추가된 상태이면
    if(overlayOn) {
      // 마커의 위치를 현재 로드뷰의 위치로 설정합니다
      marker.setPosition(rvPosition);
    }
  });

  // 마커 이미지를 생성합니다
  var markImage = new daum.maps.MarkerImage(
    'http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/roadview_wk.png',
    new daum.maps.Size(35,39), {
      //마커의 좌표에 해당하는 이미지의 위치를 설정합니다.
      //이미지의 모양에 따라 값은 다를 수 있으나, 보통 width/2, height를 주면 좌표에 이미지의 하단 중앙이 올라가게 됩니다.
      offset: new daum.maps.Point(14, 39)
    });

  // 드래그가 가능한 마커를 생성합니다
  var marker = new daum.maps.Marker({
    image : markImage,
    position: map,
    draggable: true
  });

  // 마커에 dragend 이벤트를 등록합니다
  daum.maps.event.addListener(marker, 'dragend', function(mouseEvent) {
    // 현재 마커가 놓인 자리의 좌표입니다
    var position = marker.getPosition();

    // 마커가 놓인 위치를 기준으로 로드뷰를 설정합니다
    toggleRoadview(position);
  });

  //지도에 클릭 이벤트를 등록합니다
  daum.maps.event.addListener(map, 'click', function(mouseEvent){

    // 지도 위에 로드뷰 도로 오버레이가 추가된 상태가 아니면 클릭이벤트를 무시합니다
    if(!overlayOn) {
      return;
    }

    // 클릭한 위치의 좌표입니다
    var position = mouseEvent.latLng;

    // 마커를 클릭한 위치로 옮깁니다
    marker.setPosition(position);

    // 클락한 위치를 기준으로 로드뷰를 설정합니다
    toggleRoadview(position);
  });

  // 전달받은 좌표(position)에 가까운 로드뷰의 파노라마 ID를 추출하여
  // 로드뷰를 설정하는 함수입니다
  function toggleRoadview(position){
    rvClient.getNearestPanoId(position, 50, function(panoId) {
      // 파노라마 ID가 null 이면 로드뷰를 숨깁니다
      if (panoId === null) {
        toggleMapWrapper(true, position);
      } else {
        toggleMapWrapper(false, position);

        // panoId로 로드뷰를 설정합니다
        rv.setPanoId(panoId, position);
      }
    });
  }

  // 지도를 감싸고 있는 div의 크기를 조정하는 함수입니다
  function toggleMapWrapper(active, position) {
    if (active) {

      // 지도를 감싸고 있는 div의 너비가 100%가 되도록 class를 변경합니다
      container.className = '';

      // 지도의 크기가 변경되었기 때문에 relayout 함수를 호출합니다
      map.relayout();

      // 지도의 너비가 변경될 때 지도중심을 입력받은 위치(position)로 설정합니다
      map.setCenter(position);
    } else {

      // 지도만 보여지고 있는 상태이면 지도의 너비가 50%가 되도록 class를 변경하여
      // 로드뷰가 함께 표시되게 합니다
      if (container.className.indexOf('view_roadview') === -1) {
        container.className = 'view_roadview';

        // 지도의 크기가 변경되었기 때문에 relayout 함수를 호출합니다
        map.relayout();

        // 지도의 너비가 변경될 때 지도중심을 입력받은 위치(position)로 설정합니다
        map.setCenter(position);
      }
    }
  }

  // 지도 위의 로드뷰 도로 오버레이를 추가,제거하는 함수입니다
  function toggleOverlay(active) {
    if (active) {
      overlayOn = true;

      // 지도 위에 로드뷰 도로 오버레이를 추가합니다
      map.addOverlayMapTypeId(daum.maps.MapTypeId.ROADVIEW);

      // 지도 위에 마커를 표시합니다
      marker.setMap(map);

      // 마커의 위치를 지도 중심으로 설정합니다
      marker.setPosition(map.getCenter());

      // 로드뷰의 위치를 지도 중심으로 설정합니다
      toggleRoadview(map.getCenter());
    } else {
      overlayOn = false;

      // 지도 위의 로드뷰 도로 오버레이를 제거합니다
      map.removeOverlayMapTypeId(daum.maps.MapTypeId.ROADVIEW);

      // 지도 위의 마커를 제거합니다
      marker.setMap(null);
    }
  }

  // 지도 위의 로드뷰 버튼을 눌렀을 때 호출되는 함수입니다
  function setRoadviewRoad() {
    var control = document.getElementById('roadviewControl');

    // 버튼이 눌린 상태가 아니면
    if (control.className.indexOf('active') === -1) {
      control.className = 'active';

      // 로드뷰 도로 오버레이가 보이게 합니다
      toggleOverlay(true);
    } else {
      control.className = '';

      // 로드뷰 도로 오버레이를 제거합니다
      toggleOverlay(false);
    }
  }

  // 로드뷰에서 X버튼을 눌렀을 때 로드뷰를 지도 뒤로 숨기는 함수입니다
  function closeRoadview() {
    var position = marker.getPosition();
    toggleMapWrapper(true, position);
  }

  function drawMapMarker(){
    // 데이터를 가져오기 위해 jQuery를 사용합니다
    // 데이터를 가져와 마커를 생성하고 클러스터러 객체에 넘겨줍니다
    $.get("http://rest.goodroad.co.kr/api/reports/search/year?p=" + $('#year').val(), function(data) {
      var markers = $(data._embedded.reports).map(function(i, report) {
        var marker = new daum.maps.Marker({
           position : new daum.maps.LatLng(report.lat, report.lng)
          ,clickable: true
        });

        // 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성합니다
        var iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
        // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
        var iwContent = '<div style="padding:20px;">';
        iwContent += report.address;
        iwContent += ', ' + report.group1;
        iwContent += ', ' + report.group2;
        iwContent += ', ' + report.writeDate;
        iwContent += '</div>'

        // 인포윈도우를 생성합니다
        var infowindow = new daum.maps.InfoWindow({
          content : iwContent,
          removable : iwRemoveable
        });

        // 마커에 클릭이벤트를 등록합니다
        daum.maps.event.addListener(marker, 'click', function() {
          // 마커 위에 인포윈도우를 표시합니다
          infowindow.open(map, marker);
        });

        return marker;
      });

      clusterer.addMarkers(markers);
    });
  }

  $(document).ready(function(){
    $('#year').setYearSelectData();
    $('#searchBtn').click(function(){
      clusterer.clear();
      drawMapMarker();
    });

    drawMapMarker();
  });
</script>
</body>
</html>
</body>
</html>
